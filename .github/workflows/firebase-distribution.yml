name: Firebase Distribution

on:
  workflow_run:
    workflows: ["Release Preflight"]
    types:
      - completed
  workflow_dispatch:

concurrency:
  group: firebase-distribution-${{ github.ref }}
  cancel-in-progress: true

jobs:
  distribute:
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' &&
       github.event.workflow_run.conclusion == 'success' &&
       github.event.workflow_run.head_branch == 'main')
    runs-on: ubuntu-latest
    timeout-minutes: 35

    steps:
      - name: Checkout (workflow_run sha)
        if: github.event_name == 'workflow_run'
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Checkout (manual)
        if: github.event_name == 'workflow_dispatch'
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Cache Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Install Firebase CLI
        run: npm install -g firebase-tools@13.1.0

      - name: Validate required secrets
        env:
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_APP_ID: ${{ secrets.FIREBASE_APP_ID }}
          FIREBASE_TESTER_GROUP_ALIAS: ${{ secrets.FIREBASE_TESTER_GROUP_ALIAS }}
          FIREBASE_SERVICE_ACCOUNT_JSON_BASE64: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_JSON_BASE64 }}
          LOTTO_RELEASE_STORE_FILE_BASE64: ${{ secrets.LOTTO_RELEASE_STORE_FILE_BASE64 }}
          LOTTO_RELEASE_STORE_PASSWORD: ${{ secrets.LOTTO_RELEASE_STORE_PASSWORD }}
          LOTTO_RELEASE_KEY_ALIAS: ${{ secrets.LOTTO_RELEASE_KEY_ALIAS }}
          LOTTO_RELEASE_KEY_PASSWORD: ${{ secrets.LOTTO_RELEASE_KEY_PASSWORD }}
        run: |
          set -euo pipefail
          : "${FIREBASE_PROJECT_ID:?Missing FIREBASE_PROJECT_ID}"
          : "${FIREBASE_APP_ID:?Missing FIREBASE_APP_ID}"
          : "${FIREBASE_TESTER_GROUP_ALIAS:?Missing FIREBASE_TESTER_GROUP_ALIAS}"
          : "${FIREBASE_SERVICE_ACCOUNT_JSON_BASE64:?Missing FIREBASE_SERVICE_ACCOUNT_JSON_BASE64}"
          : "${LOTTO_RELEASE_STORE_FILE_BASE64:?Missing LOTTO_RELEASE_STORE_FILE_BASE64}"
          : "${LOTTO_RELEASE_STORE_PASSWORD:?Missing LOTTO_RELEASE_STORE_PASSWORD}"
          : "${LOTTO_RELEASE_KEY_ALIAS:?Missing LOTTO_RELEASE_KEY_ALIAS}"
          : "${LOTTO_RELEASE_KEY_PASSWORD:?Missing LOTTO_RELEASE_KEY_PASSWORD}"

      - name: Prepare release signing from secrets
        env:
          LOTTO_RELEASE_STORE_FILE_BASE64: ${{ secrets.LOTTO_RELEASE_STORE_FILE_BASE64 }}
          LOTTO_RELEASE_STORE_PASSWORD: ${{ secrets.LOTTO_RELEASE_STORE_PASSWORD }}
          LOTTO_RELEASE_KEY_ALIAS: ${{ secrets.LOTTO_RELEASE_KEY_ALIAS }}
          LOTTO_RELEASE_KEY_PASSWORD: ${{ secrets.LOTTO_RELEASE_KEY_PASSWORD }}
        run: |
          set -euo pipefail
          STORE_FILE="$RUNNER_TEMP/weeklylotto-release.jks"
          echo "$LOTTO_RELEASE_STORE_FILE_BASE64" | base64 --decode > "$STORE_FILE"
          {
            echo "LOTTO_RELEASE_STORE_FILE=$STORE_FILE"
            echo "LOTTO_RELEASE_STORE_PASSWORD=$LOTTO_RELEASE_STORE_PASSWORD"
            echo "LOTTO_RELEASE_KEY_ALIAS=$LOTTO_RELEASE_KEY_ALIAS"
            echo "LOTTO_RELEASE_KEY_PASSWORD=$LOTTO_RELEASE_KEY_PASSWORD"
          } >> "$GITHUB_ENV"

      - name: Prepare Firebase service account
        env:
          FIREBASE_SERVICE_ACCOUNT_JSON_BASE64: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_JSON_BASE64 }}
        run: |
          set -euo pipefail
          SA_FILE="$RUNNER_TEMP/firebase-service-account.json"
          echo "$FIREBASE_SERVICE_ACCOUNT_JSON_BASE64" | base64 --decode > "$SA_FILE"
          echo "GOOGLE_APPLICATION_CREDENTIALS=$SA_FILE" >> "$GITHUB_ENV"

      - name: Run quality gate before distribution
        run: ./scripts/release-preflight.sh --with-build-ci --skip-adb --require-signing

      - name: Distribute to Firebase App Distribution
        env:
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_APP_ID: ${{ secrets.FIREBASE_APP_ID }}
          FIREBASE_TESTER_GROUP_ALIAS: ${{ secrets.FIREBASE_TESTER_GROUP_ALIAS }}
          FIREBASE_TESTER_GROUP_DISPLAY_NAME: ${{ secrets.FIREBASE_TESTER_GROUP_DISPLAY_NAME }}
        run: |
          set -euo pipefail
          RELEASE_NOTES="CI 배포: ${GITHUB_SHA} / run #${GITHUB_RUN_NUMBER}"
          cmd=(
            ./scripts/firebase-distribute.sh
            --project-id "$FIREBASE_PROJECT_ID"
            --app-id "$FIREBASE_APP_ID"
            --service-account "$GOOGLE_APPLICATION_CREDENTIALS"
            --groups "$FIREBASE_TESTER_GROUP_ALIAS"
            --no-build
            --apk-path app/build/outputs/apk/release/app-release.apk
            --release-notes "$RELEASE_NOTES"
          )
          if [[ -n "${FIREBASE_TESTER_GROUP_DISPLAY_NAME:-}" ]]; then
            cmd+=(--group-display-name "$FIREBASE_TESTER_GROUP_DISPLAY_NAME" --group-alias "$FIREBASE_TESTER_GROUP_ALIAS")
          fi
          "${cmd[@]}"
