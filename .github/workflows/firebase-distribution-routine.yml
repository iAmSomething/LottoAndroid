name: Firebase Distribution Routine

on:
  schedule:
    - cron: "0 1 * * 1"
  workflow_dispatch:

concurrency:
  group: firebase-distribution-routine-${{ github.ref }}
  cancel-in-progress: true

jobs:
  routine-check:
    runs-on: ubuntu-latest
    timeout-minutes: 35

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Cache Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Install Firebase CLI
        run: npm install -g firebase-tools@13.1.0

      - name: Run routine dry-run chain
        env:
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_APP_ID: ${{ secrets.FIREBASE_APP_ID }}
          FIREBASE_TESTER_GROUP_ALIAS: ${{ secrets.FIREBASE_TESTER_GROUP_ALIAS }}
          FIREBASE_TESTER_GROUP_DISPLAY_NAME: ${{ secrets.FIREBASE_TESTER_GROUP_DISPLAY_NAME }}
          FIREBASE_SERVICE_ACCOUNT_JSON_BASE64: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_JSON_BASE64 }}
          LOTTO_RELEASE_STORE_FILE_BASE64: ${{ secrets.LOTTO_RELEASE_STORE_FILE_BASE64 }}
          LOTTO_RELEASE_STORE_PASSWORD: ${{ secrets.LOTTO_RELEASE_STORE_PASSWORD }}
          LOTTO_RELEASE_KEY_ALIAS: ${{ secrets.LOTTO_RELEASE_KEY_ALIAS }}
          LOTTO_RELEASE_KEY_PASSWORD: ${{ secrets.LOTTO_RELEASE_KEY_PASSWORD }}
        run: |
          set -euo pipefail
          REPORT_PATH="docs/assets/distribution/firebase_routine_ci_${GITHUB_RUN_ID}.md"
          ./scripts/firebase-distribution-routine-check.sh --report-file "$REPORT_PATH"

      - name: Upload routine report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: firebase-distribution-routine-${{ github.run_id }}
          path: docs/assets/distribution/firebase_routine_ci_${{ github.run_id }}.md
