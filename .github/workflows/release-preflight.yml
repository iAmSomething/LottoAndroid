name: Release Preflight

on:
  workflow_dispatch:
  push:
    branches: [ main, develop, 'codex/**' ]
  pull_request:

concurrency:
  group: release-preflight-${{ github.ref }}
  cancel-in-progress: true

jobs:
  preflight:
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Cache Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Prepare release signing from secrets
        if: github.event_name != 'pull_request'
        env:
          LOTTO_RELEASE_STORE_FILE_BASE64: ${{ secrets.LOTTO_RELEASE_STORE_FILE_BASE64 }}
          LOTTO_RELEASE_STORE_PASSWORD: ${{ secrets.LOTTO_RELEASE_STORE_PASSWORD }}
          LOTTO_RELEASE_KEY_ALIAS: ${{ secrets.LOTTO_RELEASE_KEY_ALIAS }}
          LOTTO_RELEASE_KEY_PASSWORD: ${{ secrets.LOTTO_RELEASE_KEY_PASSWORD }}
        run: |
          set -euo pipefail

          : "${LOTTO_RELEASE_STORE_FILE_BASE64:?Missing secret LOTTO_RELEASE_STORE_FILE_BASE64}"
          : "${LOTTO_RELEASE_STORE_PASSWORD:?Missing secret LOTTO_RELEASE_STORE_PASSWORD}"
          : "${LOTTO_RELEASE_KEY_ALIAS:?Missing secret LOTTO_RELEASE_KEY_ALIAS}"
          : "${LOTTO_RELEASE_KEY_PASSWORD:?Missing secret LOTTO_RELEASE_KEY_PASSWORD}"

          STORE_FILE="$RUNNER_TEMP/weeklylotto-release.jks"
          echo "$LOTTO_RELEASE_STORE_FILE_BASE64" | base64 --decode > "$STORE_FILE"

          {
            echo "LOTTO_RELEASE_STORE_FILE=$STORE_FILE"
            echo "LOTTO_RELEASE_STORE_PASSWORD=$LOTTO_RELEASE_STORE_PASSWORD"
            echo "LOTTO_RELEASE_KEY_ALIAS=$LOTTO_RELEASE_KEY_ALIAS"
            echo "LOTTO_RELEASE_KEY_PASSWORD=$LOTTO_RELEASE_KEY_PASSWORD"
          } >> "$GITHUB_ENV"

      - name: Run release preflight (CI mode, PR)
        if: github.event_name == 'pull_request'
        run: ./scripts/release-preflight.sh --with-build-ci --skip-adb

      - name: Run release preflight (CI mode, signed)
        if: github.event_name != 'pull_request'
        run: ./scripts/release-preflight.sh --with-build-ci --skip-adb --require-signing
